// SRI Forecast AB1 â€” Directional Trade Signals (v5)
// ST-Primary Framework: ST = Decision | VST = Timing | LT/VLT = Context
// Entry: ST SRIBI crosses positive + VST positive (precision)
// Exit: LT confirms positive (mixed/headwind) or trailing stop (tailwind)
// Â© RizenShine â€” Forecast engine by CIO

//@version=6
indicator(title="SRI Forecast AB1", shorttitle="SRI AB1", overlay=true, max_labels_count=50)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string grp_mode   = "Asset Mode"
string asset_mode = input.string("Auto-Detect", "Asset Behavior", options=["Auto-Detect", "Momentum", "Mean-Reverting"], group=grp_mode)

f_is_momentum() =>
    string t = str.upper(syminfo.ticker)
    syminfo.type == "crypto" or str.contains(t, "BTC") or str.contains(t, "ETH") or str.contains(t, "SOL") or str.contains(t, "XRP") or str.contains(t, "MSTR") or str.contains(t, "TSLA") or str.contains(t, "IBIT") or str.contains(t, "GBTC") or str.contains(t, "BITO")

string resolved_mode = asset_mode == "Auto-Detect" ? (f_is_momentum() ? "Momentum" : "Mean-Reverting") : asset_mode
bool is_mr = resolved_mode == "Mean-Reverting"

string grp_core   = "Core Settings"
int at_period     = input.int(14, "Trackline ATR Period", group=grp_core)
float at_coeff    = input.float(1.0, "Trackline ATR Coefficient", group=grp_core)
int cooldown_bars = input.int(18, "Cooldown Between Entries (bars)", group=grp_core, tooltip="Min bars between entries. 18 bars â‰ˆ 3 days on 4H.")
float trail_hw    = input.float(8.0, "Trailing Stop â€” Headwind/Mixed (%)", group=grp_core)
float trail_tw    = input.float(10.0, "Trailing Stop â€” Tailwind (%)", group=grp_core)

string grp_disp   = "Display"
bool show_table   = input.bool(true, "Show Info Table", group=grp_disp)
bool show_legend  = input.bool(true, "Show Legend", group=grp_disp)
bool show_context = input.bool(true, "Show Context Background", group=grp_disp)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRACKLINES + SRIBI (4 Timeframes)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

f_trackline(int period, float coeff) =>
    atr = ta.rma(ta.tr(true), period)
    upT = low - atr * coeff
    downT = high + atr * coeff
    cond = ta.rsi(close, period) >= 50
    var float track = 0.0
    track := cond ? math.max(upT, nz(track[1])) : math.min(downT, nz(track[1]))
    track

// VST: RB=2H, FTL=2H, STL=1D
float vst_ftl = request.security(syminfo.tickerid, "120", f_trackline(at_period, at_coeff))
float vst_stl = request.security(syminfo.tickerid, "D",   f_trackline(at_period, at_coeff))
float vst_sribi = vst_stl != 0 ? (vst_ftl - vst_stl) / vst_stl * 100 : 0

// ST: RB=4H, FTL=2H, STL=1D
float st_ftl = request.security(syminfo.tickerid, "120", f_trackline(at_period, at_coeff))
float st_stl = request.security(syminfo.tickerid, "D",   f_trackline(at_period, at_coeff))
float st_sribi = st_stl != 0 ? (st_ftl - st_stl) / st_stl * 100 : 0

// LT: RB=1D, FTL=4H, STL=1W
float lt_ftl = request.security(syminfo.tickerid, "240", f_trackline(at_period, at_coeff))
float lt_stl = request.security(syminfo.tickerid, "W",   f_trackline(at_period, at_coeff))
float lt_sribi = lt_stl != 0 ? (lt_ftl - lt_stl) / lt_stl * 100 : 0

// VLT: RB=2D, FTL=8H, STL=2W
float vlt_ftl = request.security(syminfo.tickerid, "480", f_trackline(at_period, at_coeff))
float vlt_stl = request.security(syminfo.tickerid, "2W",  f_trackline(at_period, at_coeff))
float vlt_sribi = vlt_stl != 0 ? (vlt_ftl - vlt_stl) / vlt_stl * 100 : 0

float sribi_avg = (vst_sribi + st_sribi + lt_sribi + vlt_sribi) / 4.0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTEXT CLASSIFICATION
// LT/VLT tell you the structural environment, not whether to trade
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool lt_neg  = lt_sribi < 0
bool lt_pos  = lt_sribi > 0
bool vlt_neg = vlt_sribi < 0
bool vlt_pos = vlt_sribi > 0

string context = lt_neg and vlt_neg ? "HEADWIND" : lt_pos and vlt_pos ? "TAILWIND" : "MIXED"

color ctx_bg = context == "HEADWIND" ? color.new(color.red, 94) : context == "TAILWIND" ? color.new(color.green, 94) : color.new(color.yellow, 95)
bgcolor(show_context ? ctx_bg : na)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ST-PRIMARY ENTRY SIGNAL
//
// Alert: ST SRIBI crosses positive (the DECISION)
// Entry: VST SRIBI also positive (precision TIMING)
// Context modulates exit strategy, not entry decision
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool st_cross_bull = st_sribi > 0 and nz(st_sribi[1]) <= 0
bool vst_confirms  = vst_sribi > 0

bool raw_entry = st_cross_bull and vst_confirms

// Cooldown
var int last_entry_bar = -999
bool entry_signal = raw_entry and (bar_index - last_entry_bar) > cooldown_bars

if entry_signal
    last_entry_bar := bar_index

// ST bearish cross (potential short on MR, or contrarian buy signal)
bool st_cross_bear = st_sribi < 0 and nz(st_sribi[1]) >= 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXIT TRACKING
// Mixed/Headwind: exit when LT confirms positive OR trailing stop
// Tailwind: ride with wider trailing stop
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var bool in_trade = false
var int trade_bar = 0
var float trade_entry = 0.0
var float trade_peak = 0.0
var string trade_context = ""
var float active_trail_pct = 0.0

if entry_signal
    in_trade := true
    trade_bar := bar_index
    trade_entry := close
    trade_peak := close
    trade_context := context
    active_trail_pct := (context == "TAILWIND") ? trail_tw : trail_hw

if in_trade
    trade_peak := math.max(trade_peak, close)

// Exit conditions
bool exit_lt_confirm = in_trade and trade_context != "TAILWIND" and lt_sribi > 0 and nz(lt_sribi[1]) <= 0
bool exit_trail = in_trade and close < trade_peak * (1 - active_trail_pct / 100)

bool exit_signal = exit_lt_confirm or exit_trail
string exit_reason = exit_lt_confirm ? "LT Confirm" : exit_trail ? "Trail Stop" : ""

if exit_signal
    in_trade := false

// Trade P&L for display
float trade_pnl = in_trade ? (close - trade_entry) / trade_entry * 100 : 0
float trail_level = in_trade ? trade_peak * (1 - active_trail_pct / 100) : na
int bars_held = in_trade ? bar_index - trade_bar : 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// LT backbone for reference
bool lt_bullish = lt_ftl > lt_stl
color ftl_color = lt_ftl > nz(lt_ftl[1]) ? color.new(color.teal, 30) : color.new(color.maroon, 30)
plot(lt_ftl, "LT Fast Trackline", color=ftl_color, linewidth=2, style=plot.style_circles)
plot(lt_stl, "LT Slow Trackline", color=lt_bullish ? color.new(color.teal, 40) : color.new(color.maroon, 40), linewidth=2)

// Trailing stop level
plot(trail_level, "Trail Stop", color=color.new(color.orange, 50), linewidth=1, style=plot.style_stepline)

// Entry markers
color fluorescent_green = #39FF14
plotshape(entry_signal and context == "HEADWIND", title="Entry Headwind", location=location.belowbar, style=shape.diamond, color=color.red, size=size.small)
plotshape(entry_signal and context == "MIXED", title="Entry Mixed", location=location.belowbar, style=shape.diamond, color=color.yellow, size=size.small)
plotshape(entry_signal and context == "TAILWIND", title="Entry Tailwind", location=location.belowbar, style=shape.diamond, color=fluorescent_green, size=size.small)

// Exit markers
plotshape(exit_lt_confirm, title="Exit LT Confirm", location=location.abovebar, style=shape.xcross, color=color.new(color.blue, 20), size=size.tiny)
plotshape(exit_trail, title="Exit Trail Stop", location=location.abovebar, style=shape.xcross, color=color.new(color.orange, 20), size=size.tiny)

// ST alert (not yet confirmed by VST â€” watch for entry)
plotshape(st_cross_bull and not vst_confirms and not raw_entry, title="ST Alert (VST pending)", location=location.belowbar, style=shape.circle, color=color.new(color.gray, 50), size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INFO TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table info_tbl = table.new(position.bottom_right, 2, 12, bgcolor=color.new(color.black, 30), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and show_table
    string mode_tag = is_mr ? "MR" : "TR"
    string auto_tag = asset_mode == "Auto-Detect" ? "âš¡" : ""

    color ctx_clr = context == "HEADWIND" ? color.red : context == "TAILWIND" ? color.green : color.yellow
    string ctx_icon = context == "HEADWIND" ? "ğŸ”´" : context == "TAILWIND" ? "ğŸŸ¢" : "ğŸŸ¡"
    
    color hdr_clr = in_trade ? color.new(color.teal, 20) : color.new(color.gray, 30)
    table.cell(info_tbl, 0, 0, str.format("AB1 [{0}]{1}", mode_tag, auto_tag), text_color=color.white, text_size=size.small, bgcolor=hdr_clr)
    table.cell(info_tbl, 1, 0, in_trade ? "IN TRADE" : "Watching", text_color=color.white, text_size=size.small, bgcolor=hdr_clr)

    table.cell(info_tbl, 0, 1, "Context", text_color=color.gray, text_size=size.tiny)
    table.cell(info_tbl, 1, 1, str.format("{0} {1}", ctx_icon, context), text_color=ctx_clr, text_size=size.tiny)

    // TF Hierarchy
    table.cell(info_tbl, 0, 2, "ST (Decision)", text_color=color.white, text_size=size.tiny)
    table.cell(info_tbl, 1, 2, str.format("{0} {1}", st_sribi > 0 ? "â—" : "â—‹", str.tostring(st_sribi, "#.#")), text_color=st_sribi > 0 ? color.teal : color.red, text_size=size.tiny)

    table.cell(info_tbl, 0, 3, "VST (Timing)", text_color=color.white, text_size=size.tiny)
    table.cell(info_tbl, 1, 3, str.format("{0} {1}", vst_sribi > 0 ? "â—" : "â—‹", str.tostring(vst_sribi, "#.#")), text_color=vst_sribi > 0 ? color.teal : color.red, text_size=size.tiny)

    table.cell(info_tbl, 0, 4, "LT (Context)", text_color=color.gray, text_size=size.tiny)
    table.cell(info_tbl, 1, 4, str.format("{0} {1}", lt_sribi > 0 ? "â–²" : "â–¼", str.tostring(lt_sribi, "#.#")), text_color=lt_sribi > 0 ? color.teal : color.red, text_size=size.tiny)

    table.cell(info_tbl, 0, 5, "VLT (Context)", text_color=color.gray, text_size=size.tiny)
    table.cell(info_tbl, 1, 5, str.format("{0} {1}", vlt_sribi > 0 ? "â–²" : "â–¼", str.tostring(vlt_sribi, "#.#")), text_color=vlt_sribi > 0 ? color.teal : color.red, text_size=size.tiny)

    table.cell(info_tbl, 0, 6, "SRIBI Avg", text_color=color.gray, text_size=size.tiny)
    table.cell(info_tbl, 1, 6, str.tostring(sribi_avg, "#.#"), text_color=sribi_avg > 0 ? color.teal : color.red, text_size=size.tiny)

    // Trade status
    if in_trade
        color pnl_clr = trade_pnl > 0 ? color.green : color.red
        table.cell(info_tbl, 0, 7, "P&L", text_color=color.gray, text_size=size.tiny)
        table.cell(info_tbl, 1, 7, str.format("{0}% ({1}b)", str.tostring(trade_pnl, "+#.#;-#.#"), bars_held), text_color=pnl_clr, text_size=size.tiny)
        
        table.cell(info_tbl, 0, 8, "Trail @", text_color=color.gray, text_size=size.tiny)
        table.cell(info_tbl, 1, 8, str.format("${0} ({1}%)", str.tostring(trail_level, "#.##"), str.tostring(active_trail_pct, "#")), text_color=color.orange, text_size=size.tiny)
        
        table.cell(info_tbl, 0, 9, "Entry Ctx", text_color=color.gray, text_size=size.tiny)
        table.cell(info_tbl, 1, 9, trade_context, text_color=color.gray, text_size=size.tiny)
        
        string exit_hint = trade_context != "TAILWIND" ? "LT turns + or trail" : str.format("{0}% trail", trail_tw)
        table.cell(info_tbl, 0, 10, "Exit Rule", text_color=color.gray, text_size=size.tiny)
        table.cell(info_tbl, 1, 10, exit_hint, text_color=color.gray, text_size=size.tiny)
    else
        string next_str = st_sribi <= 0 ? "Waiting for ST+" : not vst_confirms ? "ST+ âœ“ â€” waiting VST+" : "Ready"
        table.cell(info_tbl, 0, 7, "Next", text_color=color.gray, text_size=size.tiny)
        table.cell(info_tbl, 1, 7, next_str, text_color=color.gray, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEGEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table legend_tbl = table.new(position.bottom_left, 2, 8, bgcolor=color.new(color.black, 20), border_width=1, border_color=color.new(color.gray, 70))

if barstate.islast and show_legend
    table.cell(legend_tbl, 0, 0, "AB1 v5", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 50))
    table.cell(legend_tbl, 1, 0, "ST-Primary", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.tiny)
    table.cell(legend_tbl, 0, 1, "â—† green", text_color=fluorescent_green, text_size=size.tiny)
    table.cell(legend_tbl, 1, 1, "Entry â€” Tailwind (ride)", text_color=color.white, text_size=size.tiny)
    table.cell(legend_tbl, 0, 2, "â—† yellow", text_color=color.yellow, text_size=size.tiny)
    table.cell(legend_tbl, 1, 2, "Entry â€” Mixed (LT exit)", text_color=color.white, text_size=size.tiny)
    table.cell(legend_tbl, 0, 3, "â—† red", text_color=color.red, text_size=size.tiny)
    table.cell(legend_tbl, 1, 3, "Entry â€” Headwind (tight)", text_color=color.white, text_size=size.tiny)
    table.cell(legend_tbl, 0, 4, "â—‹ gray", text_color=color.gray, text_size=size.tiny)
    table.cell(legend_tbl, 1, 4, "ST alert, VST not yet +", text_color=color.gray, text_size=size.tiny)
    table.cell(legend_tbl, 0, 5, "âœ• blue", text_color=color.blue, text_size=size.tiny)
    table.cell(legend_tbl, 1, 5, "Exit â€” LT confirmed +", text_color=color.white, text_size=size.tiny)
    table.cell(legend_tbl, 0, 6, "âœ• orange", text_color=color.orange, text_size=size.tiny)
    table.cell(legend_tbl, 1, 6, "Exit â€” Trail stop hit", text_color=color.white, text_size=size.tiny)
    table.cell(legend_tbl, 0, 7, "Background", text_color=color.gray, text_size=size.tiny)
    table.cell(legend_tbl, 1, 7, "ğŸ”´Head ğŸŸ¡Mix ğŸŸ¢Tail", text_color=color.gray, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(entry_signal, title="AB1 Entry", message="SRI AB1: ST crossed bullish + VST confirms. Context: {{plot(\"Context\")}}. Entry signal.")
alertcondition(st_cross_bull, title="AB1 ST Alert", message="SRI AB1: ST SRIBI crossed positive â€” watch for VST confirmation.")
alertcondition(exit_lt_confirm, title="AB1 Exit LT", message="SRI AB1: EXIT â€” LT SRIBI turned positive. Structural catch-up complete.")
alertcondition(exit_trail, title="AB1 Exit Trail", message="SRI AB1: EXIT â€” Trailing stop hit.")
