// SRI Forecast — Historical Analog Projection
// Simplified LT SRI backbone + 20-day forward projection ribbon
// Based on SRIBI concordance across VST/ST/LT/VLT timeframes
// Percentile tables derived from BTC backtests (2021-2026, n=1,709 daily)
// © RizenShine — Forecast engine by CIO

//@version=6
indicator(title="SRI Forecast", shorttitle="SRI Forecast", overlay=true, max_lines_count=500, max_labels_count=50)

// ═══════════════════════════════════════════════════════════════
// INPUTS
// ═══════════════════════════════════════════════════════════════
int at_period     = input.int(14, "Trackline ATR Period")
float at_coeff    = input.float(1.0, "Trackline ATR Coefficient")
int rsi_len       = input.int(14, "RSI Length")
int reg_len       = input.int(50, "LT Regression Length")
float reg_mult    = input.float(1.0, "LT Regression Deviation")
bool show_ribbon  = input.bool(true, "Show Forecast Ribbon")
bool show_label   = input.bool(true, "Show Concordance Label")

// ═══════════════════════════════════════════════════════════════
// LT SRI BACKBONE — Simplified (FTL + STL + Stage Background)
// Settings: RB=1D, FTL=4H, STL=1W
// ═══════════════════════════════════════════════════════════════

// --- LT Fast Trackline (4H) ---
string tf_lt_fast = "240"

f_trackline_fast() =>
    atr = ta.rma(ta.tr(true), at_period)
    upT = low - atr * at_coeff
    downT = high + atr * at_coeff
    cond = ta.rsi(close, at_period) >= 50
    var float track = 0.0
    track := cond ? math.max(upT, nz(track[1])) : math.min(downT, nz(track[1]))
    track

float lt_ftl = request.security(syminfo.tickerid, tf_lt_fast, f_trackline_fast())
bool lt_ftl_rising = lt_ftl > nz(lt_ftl[1])

// --- LT Slow Trackline (1W) ---
string tf_lt_slow = "W"

f_trackline_slow() =>
    atr = ta.rma(ta.tr(true), at_period)
    upT = low - atr * at_coeff
    downT = high + atr * at_coeff
    cond = ta.rsi(close, at_period) >= 50
    var float track = 0.0
    track := cond ? math.max(upT, nz(track[1])) : math.min(downT, nz(track[1]))
    track

float lt_stl = request.security(syminfo.tickerid, tf_lt_slow, f_trackline_slow())

// --- LT Stage (FTL vs STL) ---
bool lt_bullish = lt_ftl > lt_stl

// --- Plot LT Backbone ---
color ftl_color = lt_ftl_rising ? color.new(color.teal, 30) : color.new(color.maroon, 30)
plot(lt_ftl, "LT Fast Trackline", color=ftl_color, linewidth=2, style=plot.style_circles)
plot(lt_stl, "LT Slow Trackline", color=color.new(color.gray, 20), linewidth=2)

// Stage background
bgcolor(lt_bullish ? color.new(color.green, 92) : color.new(color.red, 92), title="LT Stage Background")

// ═══════════════════════════════════════════════════════════════
// SRIBI — All 4 Timeframes via request.security
// VST: RB=2H, FTL=2H, STL=1D
// ST:  RB=4H, FTL=2H, STL=1D
// LT:  RB=1D, FTL=4H, STL=1W
// VLT: RB=2D, FTL=8H, STL=2W
// ═══════════════════════════════════════════════════════════════

// SRIBI = normalized distance between FTL and STL
// Positive = bullish (FTL > STL), Negative = bearish

// We compute a simplified SRIBI proxy: (FTL - STL) / STL * 100
// For each timeframe, we need FTL and STL

// --- VST (FTL=2H, STL=1D) ---
float vst_ftl = request.security(syminfo.tickerid, "120", f_trackline_fast())
float vst_stl = request.security(syminfo.tickerid, "D", f_trackline_slow())
float vst_sribi = vst_stl != 0 ? (vst_ftl - vst_stl) / vst_stl * 100 : 0

// --- ST (FTL=2H, STL=1D) — same as VST for tracklines ---
// ST uses different RB (4H) but FTL/STL same as VST
// The SRIBI histogram in TradingView uses the RB relationship too
// For forecast purposes, we approximate with FTL/STL spread
float st_ftl = request.security(syminfo.tickerid, "120", f_trackline_fast())
float st_stl = request.security(syminfo.tickerid, "D", f_trackline_slow())
float st_sribi = st_stl != 0 ? (st_ftl - st_stl) / st_stl * 100 : 0

// --- LT (FTL=4H, STL=1W) ---
float lt_sribi = lt_stl != 0 ? (lt_ftl - lt_stl) / lt_stl * 100 : 0

// --- VLT (FTL=8H, STL=2W) ---
float vlt_ftl = request.security(syminfo.tickerid, "480", f_trackline_fast())
float vlt_stl = request.security(syminfo.tickerid, "2W", f_trackline_slow())
float vlt_sribi = vlt_stl != 0 ? (vlt_ftl - vlt_stl) / vlt_stl * 100 : 0

// --- Concordance ---
float sribi_avg = (vst_sribi + st_sribi + lt_sribi + vlt_sribi) / 4.0
int bull_count = (vst_sribi > 0 ? 1 : 0) + (st_sribi > 0 ? 1 : 0) + (lt_sribi > 0 ? 1 : 0) + (vlt_sribi > 0 ? 1 : 0)

// ═══════════════════════════════════════════════════════════════
// FORECAST PERCENTILE TABLES
// Derived from BTC daily backtests, SRIBI average quintiles
// Columns: [5d, 10d, 15d, 20d] as percentage returns
// ═══════════════════════════════════════════════════════════════

// Zone 1: Very Bearish (SRIBI avg < -25) — Contrarian bullish
// p25: [-2.91, -3.66, -4.92, -5.81]
// p50: [+0.81, +0.43, +0.70, +1.29]
// p75: [+4.21, +5.72, +6.93, +8.74]

// Zone 2: Bearish (-25 to -5)
// p25: [-3.30, -4.80, -5.83, -8.28]
// p50: [-0.24, -0.30, -0.15, -0.58]
// p75: [+2.72, +4.41, +5.18, +6.71]

// Zone 3: Neutral (-5 to +5)
// p25: [-3.00, -4.95, -5.81, -6.19]
// p50: [-0.15, -0.12, -1.03, -1.21]
// p75: [+3.21, +4.46, +5.36, +6.77]

// Zone 4: Bullish (+5 to +25)
// p25: [-2.67, -4.07, -4.61, -5.86]
// p50: [+0.29, +0.85, +0.86, +0.10]
// p75: [+3.72, +6.10, +7.19, +8.95]

// Zone 5: Very Bullish (SRIBI avg > +25)
// p25: [-2.76, -4.45, -4.79, -4.61]
// p50: [+0.08, +1.01, +1.42, +2.78]
// p75: [+3.73, +6.19, +8.98, +10.96]

// Determine current zone
int zone = sribi_avg < -25 ? 1 : sribi_avg < -5 ? 2 : sribi_avg < 5 ? 3 : sribi_avg < 25 ? 4 : 5

// Lookup tables (p25, p50, p75 for each zone at days 5, 10, 15, 20)
f_get_pct(int z, int day_idx, int pct) =>
    // day_idx: 0=5d, 1=10d, 2=15d, 3=20d
    // pct: 0=p25, 1=p50, 2=p75
    float result = 0.0
    if z == 1  // Very Bearish
        if pct == 0
            result := day_idx == 0 ? -2.91 : day_idx == 1 ? -3.66 : day_idx == 2 ? -4.92 : -5.81
        else if pct == 1
            result := day_idx == 0 ? 0.81 : day_idx == 1 ? 0.43 : day_idx == 2 ? 0.70 : 1.29
        else
            result := day_idx == 0 ? 4.21 : day_idx == 1 ? 5.72 : day_idx == 2 ? 6.93 : 8.74
    else if z == 2  // Bearish
        if pct == 0
            result := day_idx == 0 ? -3.30 : day_idx == 1 ? -4.80 : day_idx == 2 ? -5.83 : -8.28
        else if pct == 1
            result := day_idx == 0 ? -0.24 : day_idx == 1 ? -0.30 : day_idx == 2 ? -0.15 : -0.58
        else
            result := day_idx == 0 ? 2.72 : day_idx == 1 ? 4.41 : day_idx == 2 ? 5.18 : 6.71
    else if z == 3  // Neutral
        if pct == 0
            result := day_idx == 0 ? -3.00 : day_idx == 1 ? -4.95 : day_idx == 2 ? -5.81 : -6.19
        else if pct == 1
            result := day_idx == 0 ? -0.15 : day_idx == 1 ? -0.12 : day_idx == 2 ? -1.03 : -1.21
        else
            result := day_idx == 0 ? 3.21 : day_idx == 1 ? 4.46 : day_idx == 2 ? 5.36 : 6.77
    else if z == 4  // Bullish
        if pct == 0
            result := day_idx == 0 ? -2.67 : day_idx == 1 ? -4.07 : day_idx == 2 ? -4.61 : -5.86
        else if pct == 1
            result := day_idx == 0 ? 0.29 : day_idx == 1 ? 0.85 : day_idx == 2 ? 0.86 : 0.10
        else
            result := day_idx == 0 ? 3.72 : day_idx == 1 ? 6.10 : day_idx == 2 ? 7.19 : 8.95
    else  // Very Bullish
        if pct == 0
            result := day_idx == 0 ? -2.76 : day_idx == 1 ? -4.45 : day_idx == 2 ? -4.79 : -4.61
        else if pct == 1
            result := day_idx == 0 ? 0.08 : day_idx == 1 ? 1.01 : day_idx == 2 ? 1.42 : 2.78
        else
            result := day_idx == 0 ? 3.73 : day_idx == 1 ? 6.19 : day_idx == 2 ? 8.98 : 10.96
    result

// ═══════════════════════════════════════════════════════════════
// FORECAST RIBBON — Projected 20 days forward from current bar
// Only draws on the last bar to keep chart clean
// ═══════════════════════════════════════════════════════════════

// Zone colors
color zone_color = zone == 1 ? color.new(color.red, 0) : zone == 2 ? color.new(color.orange, 0) : zone == 3 ? color.new(color.gray, 0) : zone == 4 ? color.new(color.teal, 0) : color.new(color.green, 0)
color ribbon_fill = zone == 1 ? color.new(color.red, 80) : zone == 2 ? color.new(color.orange, 80) : zone == 3 ? color.new(color.gray, 85) : zone == 4 ? color.new(color.teal, 80) : color.new(color.green, 80)

string zone_name = zone == 1 ? "Very Bearish" : zone == 2 ? "Bearish" : zone == 3 ? "Neutral" : zone == 4 ? "Bullish" : "Very Bullish"

if barstate.islast and show_ribbon
    float base_price = close

    // Draw projection lines at 5d, 10d, 15d, 20d intervals
    // Interpolate between points for smooth lines
    int[] offsets = array.from(0, 5, 10, 15, 20)

    // Build projected price arrays
    var line[] bull_lines = array.new<line>()
    var line[] base_lines = array.new<line>()
    var line[] bear_lines = array.new<line>()
    var linefill[] fills  = array.new<linefill>()

    // Clean up previous drawings
    for i = 0 to array.size(bull_lines) - 1
        line.delete(array.get(bull_lines, i))
    for i = 0 to array.size(base_lines) - 1
        line.delete(array.get(base_lines, i))
    for i = 0 to array.size(bear_lines) - 1
        line.delete(array.get(bear_lines, i))
    for i = 0 to array.size(fills) - 1
        linefill.delete(array.get(fills, i))
    array.clear(bull_lines)
    array.clear(base_lines)
    array.clear(bear_lines)
    array.clear(fills)

    // Draw segments between each point pair
    for seg = 0 to 3
        int bar_start = bar_index + array.get(offsets, seg)
        int bar_end   = bar_index + array.get(offsets, seg + 1)

        // Returns at start and end of segment
        float p25_start = seg == 0 ? 0.0 : f_get_pct(zone, seg - 1, 0)
        float p50_start = seg == 0 ? 0.0 : f_get_pct(zone, seg - 1, 1)
        float p75_start = seg == 0 ? 0.0 : f_get_pct(zone, seg - 1, 2)
        float p25_end = f_get_pct(zone, seg, 0)
        float p50_end = f_get_pct(zone, seg, 1)
        float p75_end = f_get_pct(zone, seg, 2)

        float bull_y1 = base_price * (1 + p75_start / 100)
        float bull_y2 = base_price * (1 + p75_end / 100)
        float base_y1 = base_price * (1 + p50_start / 100)
        float base_y2 = base_price * (1 + p50_end / 100)
        float bear_y1 = base_price * (1 + p25_start / 100)
        float bear_y2 = base_price * (1 + p25_end / 100)

        line bl = line.new(bar_start, bull_y1, bar_end, bull_y2, color=color.new(zone_color, 50), width=1, style=line.style_dashed)
        line ml = line.new(bar_start, base_y1, bar_end, base_y2, color=zone_color, width=2)
        line sl = line.new(bar_start, bear_y1, bar_end, bear_y2, color=color.new(zone_color, 50), width=1, style=line.style_dashed)

        array.push(bull_lines, bl)
        array.push(base_lines, ml)
        array.push(bear_lines, sl)

        // Fill between bull and bear
        linefill lf = linefill.new(bl, sl, ribbon_fill)
        array.push(fills, lf)

    // End-of-ribbon label
    float end_p50 = f_get_pct(zone, 3, 1)
    float end_p75 = f_get_pct(zone, 3, 2)
    float end_p25 = f_get_pct(zone, 3, 0)
    label.new(bar_index + 22, base_price * (1 + end_p50 / 100),
         text=str.format("{0}\nMedian: {1}%\nRange: {2}% to {3}%\nSRIBI Avg: {4}", 
              zone_name, 
              str.tostring(end_p50, "#.##"),
              str.tostring(end_p25, "#.##"),
              str.tostring(end_p75, "#.##"),
              str.tostring(sribi_avg, "#.#")),
         color=zone_color, textcolor=color.white, style=label.style_label_left, size=size.small)

// ═══════════════════════════════════════════════════════════════
// CONCORDANCE INFO LABEL (current bar)
// ═══════════════════════════════════════════════════════════════

if barstate.islast and show_label
    string ct_text = str.format("CT{0} | SRIBI Avg: {1}\nVST:{2} ST:{3} LT:{4} VLT:{5}", 
         bull_count,
         str.tostring(sribi_avg, "#.#"),
         str.tostring(vst_sribi, "#.#"),
         str.tostring(st_sribi, "#.#"),
         str.tostring(lt_sribi, "#.#"),
         str.tostring(vlt_sribi, "#.#"))
    label.new(bar_index, low * 0.995, text=ct_text, 
         color=zone_color, textcolor=color.white, 
         style=label.style_label_up, size=size.small)

// ═══════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════

alertcondition(ta.cross(sribi_avg, 25.0), title="SRIBI Enters Very Bullish", message="SRI Forecast: SRIBI average crossed above +25 — Very Bullish zone")
alertcondition(ta.cross(-25.0, sribi_avg), title="SRIBI Enters Very Bearish", message="SRI Forecast: SRIBI average crossed below -25 — Very Bearish zone (contrarian bullish)")
alertcondition(ta.crossover(float(bull_count), 3.5), title="CT4 — Full Concordance", message="SRI Forecast: All 4 timeframes bullish — CT4 full concordance")
alertcondition(ta.crossunder(float(bull_count), 0.5), title="CT0 — Full Bearish", message="SRI Forecast: All 4 timeframes bearish — CT0 (watch for capitulation)")
